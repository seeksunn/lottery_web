<html>
  <head>   
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script>
      const address = "0x2DB0B8F9ba4B93550675C44c3dcf6644654e830B";
      

      const web3 = new Web3(Web3.givenProvider);

      window.addEventListener("load", async () => {
        if (typeof web3 === "undefined") {          
          alert("Metamask is not installed, you cannot use this app");
        } else {
          window.ethereum.enable();          
        }
      });

      const abi = [
        { inputs: [], stateMutability: "nonpayable", type: "constructor" },
        {
          inputs: [],
          name: "enter",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [],
          name: "getBalance",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getPlayers",
          outputs: [{ internalType: "address[]", name: "", type: "address[]" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "manager",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "pickWinner",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          name: "players",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "winner",
          outputs: [
            { internalType: "address payable", name: "", type: "address" },
          ],
          stateMutability: "view",
          type: "function",
        },
      ];

      var lottery = new web3.eth.Contract(abi, address);     
      var manager;
      async function getManager() {
        manager = await lottery.methods.manager().call();
        document.getElementById("manager").innerHTML = "Manager is " + manager;
      }      
      const addPlayer = async () => {
        const playerBalance = document.getElementById("playerBalance").value;
        const accounts = await web3.eth.getAccounts();
        playerBalance = web3.utils.toWei(playerBalance, "ether")
        await lottery.methods
          .enter()
          .send({
            from: accounts[0],
            gas: 40000,
            value: playerBalance,
          });
        updatePrizePool();
        countPlayer();
      };
      const countPlayer = async () => {
        const player = await lottery.methods.getPlayers().call();
        document.getElementById("playerCount").innerHTML =
          "There are " + player.length + " people entering the system";
      };
      const updatePrizePool = async () => {
        const balance = await lottery.method.getBalance().call();
        balance = web3.utils.fromWei(balance, "ether");
        document.getElementById("prizePool").innerHTML =
          "the winner will get " + balance + " ether";
      };
      const pickWinner = async () => {
        const accounts = await web3.eth.getAccounts();
        if (accounts[0] != manager) {
          document.getElementById("message").innerHTML =
            "You are not the manager";
          return;
        } else {
          await lottery.method
            .pickWinner()
            .send({ from: accounts[0], gas: 400000 });
          winner = await lotteryContract.methods.winner().call();
          document.getElementById("winner").innerHTML =
            "the winner is" + winner;
          updatePrizePool();
          countPlayer();
        }
      };
    </script>
  </head>
  <body>
    <script>
      getManager();
    </script>
    <h2>Lottery Contract</h2>
    <div id="manager"></div>    
    <div id="playerCount">There are 0 people entering the system</div>
    <div id="prizePool">the winner will get 0 ether</div>
    <hr />
    <h4>Wanna Play?</h4>
    How much ether you want to enter (>=0.01 ether)<input
      type="text"
      id="playerBalance"
    />
    <button type="button" onclick="addPlayer()">Enter</button>
    <hr />
    <h4>Ready to pick winner?</h4>
    <button type="button" onclick="pickWinner()">Pick Winner</button>
    <div id="winner"></div>
  </body>
</html>
